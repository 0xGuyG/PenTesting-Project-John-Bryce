import os
import subprocess
import time

# Install the necessary apps
def install():
    print("[*] Updating System")
    os.system("sudo apt-get update")
    apps = ["nmap", "ipcalc", "searchsploit", "hydra", "crunch"]
    for app in apps:
        print(f"[*] Installing {app}")
        os.system(f"sudo apt-get install {app} -y")

# Acquire start of scan to calculate runtime
start = time.time()

# Ascertain the LAN range
def Q1():
    os.chdir("~/Desktop")
    network_info = subprocess.getoutput("ipcalc -n $(hostname -I)")
    network = [line.split()[1] for line in network_info.split('\n') if "network" in line.lower()][0]
    print(f"{network} is the LAN Range")
    print("Commencing Ping Sweep:")
    subnet = subprocess.getoutput("ip route | grep default | awk '{print $3}' | cut -d '.' -f 1-3")
    subnet = subnet.strip()
    
    active_devices = []
    for ip in range(1, 255):
        ip_address = f"{subnet}.{ip}"
        print(f"Pinging {ip_address}")
        ping_result = os.system(f"ping -c 1 -W 1 {ip_address} > /dev/null 2>&1")
        if ping_result == 0:
            active_devices.append(ip_address)
            os.system(f"nmap -sV -T4 {ip_address} -oX {ip_address}")

    for device in active_devices:
        print(f"Scanning {device} for vulnerabilities...")
        result = subprocess.getoutput(f"nmap -sV -sC --script vuln -p- {device} -oN {device}-vuln")
        sploit = subprocess.getoutput(f"searchsploit --nmap {device} > {device}-sploit")
        if "Host is up" in result:
            with open(f"{device}-vuln", "a") as vuln_file:
                vuln_file.write("\n")
                vuln_file.write(sploit)
                vuln_file.write("\n")
        else:
            print(f"No vulnerabilities found on {device}.")

# Q2 function
def Q2():
    os.chdir("~/Desktop")

    user_file = input("Enter the path to the user list file: ")
    
    choice = input("Do you want to use an existing password list or create a new one? (e/c)")
    
    if choice == "e":
        password_file = input("Enter the path to the password list file: ")
    else:
        min_length = input("Enter minimum length for string: ")
        max_length = input("Enter maximum length for string: ")
        charset = input("Enter character set for string: ")
        os.system(f"crunch {min_length} {max_length} {charset} -o passwordlist.txt")
        print("The password list was created at Desktop and was named passwordlist.txt")
        w = os.getlogin()
        password_file = f"/home/{w}/Desktop/passwordlist.txt"

    active_devices = []
    for device in active_devices:
        open_ports_info = subprocess.getoutput(f"nmap -p- --open -sV {device} | grep 'open' | awk '{{print $1}}' | tr '/tcp' ' '")
        open_ports = open_ports_info.split()
        for port in open_ports:
            service_info = subprocess.getoutput(f"nmap -p {port} -sV {device} | grep '{port}/' | awk '{{print $3}}'")
            service = service_info.strip()
            if service in ["ftp", "ssh", "telnet", "http", "pop3", "imap", "smtp", "smb"]:
                print(f"Running hydra on {service} service on port {port} on device {device}")
                os.system(f"hydra -L {user_file} -P {password_file} {service}://{device}:{port} -v >> {device}-vuln")
            else:
                print(f"No login service available on {device} on service {service} on port {port}")

# Acquire scan finishing time
end = time.time()

# Q3 function
def Q3():
    print(f"There were {len(active_devices)} active devices that were scanned")
    runtime = int(end - start)
    print(f"The scan time was {runtime} seconds")
    print("The reports on each live host were saved on your desktop individually and end with the suffix -vuln")
    machine = input("If you would like to view the results of a specific machine, please enter its IP now: ")
    with open(f"{machine}-vuln", "r") as machine_vuln_file:
        print(machine_vuln_file.read())

# Execute the functions
install()
Q1()
Q2()
Q3()
